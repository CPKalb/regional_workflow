[config]

# Configuration-related settings such as the process list, begin and end times, etc.

# Removing PcpCombine from list to prevent pcp_combine from running since
# that is already called for each member in the deterministic vx tasks
# for each member.
#
# Note that we can't leave the pcp_combine task active in this conf file
# because it cannot handle the time-lagged ensembles (because the variables
# FCST_PCP_COMBINE_INPUT_TEMPLATE and FCST_PCP_COMBINE_OUTPUT_TEMPLATE
# cannot take be lists/arrays, unlike GEN_ENS_PROD_INPUT_TEMPLATE).
#PROCESS_LIST = PcpCombine, GenEnsProd
PROCESS_LIST = GenEnsProd

###
# Time Info
###

# LOOP_BY: Set to INIT to loop over initialization times
LOOP_BY = INIT

# Format of INIT_BEG and INT_END
INIT_TIME_FMT = %Y%m%d%H

# Start time for METplus run
INIT_BEG={ENV[CDATE]}

# End time for METplus run
INIT_END={ENV[CDATE]}

# Increment between METplus runs in seconds. Must be >= 60
INIT_INCREMENT = 3600

# List of forecast leads to process
LEAD_SEQ = {ENV[fhr_list]}

LOOP_ORDER = times

###
# File I/O
###

# Loop through ensmeble members for making precip buckets
#PCP_COMBINE_CUSTOM_LOOP_LIST = membegin_end_incr(1,{ENV[NUM_ENS_MEMBERS]},1,{ENV[NUM_PAD]})

# Forecast model input directory for gen_ens_prod
INPUT_BASE = {ENV[INPUT_BASE]}
GEN_ENS_PROD_INPUT_DIR = {FCST_PCP_COMBINE_OUTPUT_DIR}

# Input and output fcst data directories for pcp-combine
FCST_PCP_COMBINE_INPUT_DIR = {INPUT_BASE}
FCST_PCP_COMBINE_OUTPUT_DIR = {OUTPUT_BASE}

# Need to have PCPCombine output data to individual member directories.
#FCST_PCP_COMBINE_INPUT_TEMPLATE = {init?fmt=%Y%m%d%H}/{custom?fmt=%s}/postprd/{ENV[NET]}.t{init?fmt=%H}z.bgdawpf{lead?fmt=%HHH}.tm{init?fmt=%H}.grib2
#FCST_PCP_COMBINE_OUTPUT_TEMPLATE = {custom?fmt=%s}/metprd_vxold/pcp_combine/{ENV[NET]}.t{init?fmt=%H}z.bgdawpf{lead?fmt=%HHH}.tm{init?fmt=%H}_a06h.nc

#
# The template FCST_PCP_COMBINE_INPUT_TEMPLATE is relative to
# FCST_PCP_COMBINE_INPUT_DIR.
#
# FCST_PCP_COMBINE_INPUT_DIR gets set above to INPUT_BASE, which in the
# workflow's ex-script "exregional_run_ensgridvx.sh" gets set to
# ${VX_FCST_INPUT_BASEDIR}.  
#
# Since ${VX_FCST_INPUT_BASEDIR} does not include the cycle date ($CDATE, in the 
# form YYYYMMDDHH), below we have to prepend it to each element of 
# FCST_PCP_COMBINE_INPUT_TEMPLATE.
#
# Note that the CDATE variable in the environment that is accessed by
# this configuration file is the non-time-lagged value.  Thus, in 
# specifying the various cycle dates at the start of each element of
# FCST_PCP_COMBINE_INPUT_TEMPLATE, we must perform the appropriate
# time shift to find the correct directory.
#
#FCST_PCP_COMBINE_INPUT_TEMPLATE =
#  {init?fmt=%Y%m%d%H}/mem1/postprd/{ENV[NET]}.t{init?fmt=%H}z.bgdawpf{lead?fmt=%HHH}.tm00.grib2,
#  {init?fmt=%Y%m%d%H?shift=-43200}/mem2/postprd/{ENV[NET]}.t{init?fmt=%H?shift=-43200}z.bgdawpf{lead?fmt=%HHH?shift=43200}.tm00.grib2
#
# The above doesn't work because it turns out FCST_PCP_COMBINE_INPUT_TEMPLATE
# can't be set to a variable.  Temporary solution is to not call pcp_combine
# on the forecast output and instead assume that this has already been
# done for each ensemble member in the deterministic vx tasks.  Thus, 
# here we can set FCST_PCP_COMBINE_INPUT_TEMPLATE to a null string.
#
FCST_PCP_COMBINE_INPUT_TEMPLATE =
#
# The template FCST_PCP_COMBINE_OUTPUT_TEMPLATE is relative to
# FCST_PCP_COMBINE_OUTPUT_DIR.
#
# FCST_PCP_COMBINE_OUTPUT_DIR gets set above to OUTPUT_BASE, which in
# the workflow's ex-script "exregional_run_ensgridvx.sh" gets set to
# ${VX_OUTPUT_BASEDIR}.
#
# Since ${VX_OUTPUT_BASEDIR} does not include CDATE, below we have to 
# prepend the cycle date to each element of FCST_PCP_COMBINE_OUTPUT_TEMPLATE.
# In doing so, we must include the shift in time because as stated above,
# CDATE in this configuration file is always the non-time-lagged value.
#
#FCST_PCP_COMBINE_OUTPUT_TEMPLATE =
#  {init?fmt=%Y%m%d%H}/mem1/metprd_vxold/pcp_combine/{ENV[NET]}.t{init?fmt=%H}z.bgdawpf{lead?fmt=%HHH}.tm00_a06h.nc,
#  {init?fmt=%Y%m%d%H?shift=-43200}/mem2/metprd_vxold/pcp_combine/{ENV[NET]}.t{init?fmt=%H?shift=-43200}z.bgdawpf{lead?fmt=%HHH?shift=43200}.tm00_a06h.nc
#
# Since pcp_combine is not being called on the forecast output due to 
# the issue with FCST_PCP_COMBINE_INPUT_TEMPLATE described above (it 
# cannot be set to an array), set FCST_PCP_COMBINE_OUTPUT_TEMPLATE to a
# null string.  Likely FCST_PCP_COMBINE_OUTPUT_TEMPLATE also cannot be
# set to an array, but that has not been verified.
#
FCST_PCP_COMBINE_OUTPUT_TEMPLATE =

# Comma separated list of ensemble members
#GEN_ENS_PROD_INPUT_TEMPLATE =
#  membegin_end_incr(1,{ENV[NUM_ENS_MEMBERS]},1,{ENV[NUM_PAD]})/metprd_vxold/pcp_combine/{ENV[NET]}.t{init?fmt=%H}z.bgdawpf{lead?fmt=%HHH}.tm{init?fmt=%H}_a06h.nc

#
# The template GEN_ENS_PROD_INPUT_TEMPLATE is relative to GEN_ENS_PROD_INPUT_DIR.
#
# GEN_ENS_PROD_INPUT_TEMPLATE together with GEN_ENS_PROD_INPUT_DIR must
# give the same paths as FCST_PCP_COMBINE_OUTPUT_TEMPLATE together with
# FCST_PCP_COMBINE_OUTPUT_DIR because the output files from pcp_combine
# are the inputs to gen_ens_prod.
#
# GEN_ENS_PROD_INPUT_DIR gets set above to FCST_PCP_COMBINE_OUTPUT_DIR.
# Thus, we must set GEN_ENS_PROD_INPUT_TEMPLATE to FCST_PCP_COMBINE_OUTPUT_TEMPLATE.
#
#GEN_ENS_PROD_INPUT_TEMPLATE =
#  {init?fmt=%Y%m%d%H}/mem1/metprd_vxold/pcp_combine/{ENV[NET]}.t{init?fmt=%H}z.bgdawpf{lead?fmt=%HHH}.tm00_a06h.nc,
#  {init?fmt=%Y%m%d%H?shift=-43200}/mem2/metprd_vxold/pcp_combine/{ENV[NET]}.t{init?fmt=%H?shift=-43200}z.bgdawpf{lead?fmt=%HHH?shift=43200}.tm00_a06h.nc
#GEN_ENS_PROD_INPUT_TEMPLATE = {FCST_PCP_COMBINE_OUTPUT_TEMPLATE}
GEN_ENS_PROD_INPUT_TEMPLATE = {ENV[fcst_pcp_combine_output_template]}

# Run pcp_combine on forecast data?
FCST_PCP_COMBINE_RUN = True
#FCST_PCP_COMBINE_RUN = False

# Mode of pcp_combine to use (SUM, ADD, SUBTRACT)
FCST_PCP_COMBINE_METHOD = ADD

FCST_PCP_COMBINE_CONSTANT_INIT = True

# Accumulation interval available in forecast data
FCST_PCP_COMBINE_INPUT_ACCUMS = 01
FCST_PCP_COMBINE_OUTPUT_ACCUM = 06

# If 'bucket' output already exists, skip the PcpCombine step for the data
PCP_COMBINE_SKIP_IF_OUTPUT_EXISTS = True

# Forecast data description variables
FCST_PCP_COMBINE_INPUT_DATATYPE = GRIB
FCST_IS_PROB = false

# GEN_ENS_PROD_CTRL_INPUT_DIR = {INPUT_BASE}
# GEN_ENS_PROD_CTRL_INPUT_TEMPLATE =
#  {init?fmt=%Y%m%d%H}/mem1/postprd/{ENV[NET]}.t{init?fmt=%H}z.bgdawpf{lead?fmt=%HHH}.tm{init?fmt=%H}.grib2

# There are n ensembles but 1 is used as control, so specify n-1 members
GEN_ENS_PROD_N_MEMBERS = {ENV[NUM_ENS_MEMBERS]}

OUTPUT_BASE = {ENV[OUTPUT_BASE]}
GEN_ENS_PROD_OUTPUT_DIR = {OUTPUT_BASE}
#
# The template GEN_ENS_PROD_OUTPUT_TEMPLATE is relative to GEN_ENS_PROD_OUTPUT_DIR.
#
# GEN_ENS_PROD_OUTPUT_DIR gets set above to OUTPUT_BASE, which in the
# workflow's ex-script "exregional_run_ensgridvx.sh" gets set to
# ${VX_OUTPUT_BASEDIR}.
#
# Since ${VX_OUTPUT_BASEDIR} does not include CDATE, below we have to 
# prepend the cycle date to it.  Note that the output of gen_ens_prod
# is for the whole ensemble, so we place it in the directory having the
# nominal cycle date, which is the one with no time-lagging.
#
GEN_ENS_PROD_OUTPUT_TEMPLATE = {ENV[CDATE]}/metprd_vxold/gen_ens_prod/gen_ens_prod_{MODEL}_{ENV[FIELDNAME_IN_MET_FILEDIR_NAMES]}_{valid?fmt=%Y%m%d_%H%M%S}V.nc

# Specify the name of the metplus.log file
LOG_METPLUS = {LOG_DIR}/metplus.log.gep_{ENV[LOG_SUFFIX]}

# Specify where the location and name of the final metplus_final.conf
METPLUS_CONF = {OUTPUT_BASE}/{ENV[CDATE]}/metprd_vxold/gen_ens_prod/metplus_final.gep_{ENV[FIELDNAME_IN_MET_FILEDIR_NAMES]}.conf

# Directory for staging data
STAGING_DIR = {OUTPUT_BASE}/{ENV[CDATE]}/stage_vxold/{ENV[FIELDNAME_IN_MET_FILEDIR_NAMES]}

###
# Field Info
###

# Ensemble Variables and levels as specified in the ens field dictionary
# of the MET configuration file. Specify as ENS_VARn_NAME, ENS_VARn_LEVELS,
# (optional) ENS_VARn_OPTION
# Note:
# For APCP variables with accumulation periods greater than 1 hour (e.g.
# 03h, 06h, 24h), ENS_VAR1_NAME in the corresponding METplus configuration
# file specifies the name of the field in the NetCDF file(s) generated by
# MET's pcp_combine tool.  This tool reads in the grib2 file(s) containing
# 1 hour accumulation data and outputs NetCDF file(s) with the appropriate
# > 1 hour accumulation.  These output NetCDF files name their arrays as
# specified by the environment variable FIELDNAME_IN_MET_OUTPUT.  Thus,
# that is the value we set ENS_VAR1_NAME to here, not to the name of the
# variable in the grib2 file.
ENS_VAR1_NAME = {ENV[FIELDNAME_IN_MET_OUTPUT]}
ENS_VAR1_LEVELS = A06
ENS_VAR1_THRESH = gt0.0,ge2.54,ge6.350,ge12.700

###
# GenEnsProd
###

# The MET gen_ens_prod logging level
# 0 quiet to 5 loud, Verbosity setting for MET ensemble_stat output, 2 is default.
# This takes precendence over the general LOG_MET_VERBOSITY set in metplus_logging.conf
# LOG_GEN_ENS_PROD_VERBOSITY = 2

MODEL = {ENV[VX_FCST_MODEL_NAME]}
GEN_ENS_PROD_DESC = NA

# GEN_ENS_PROD_REGRID_TO_GRID = NONE
# GEN_ENS_PROD_REGRID_METHOD = NEAREST
# GEN_ENS_PROD_REGRID_WIDTH = 1
# GEN_ENS_PROD_REGRID_VLD_THRESH = 0.5
# GEN_ENS_PROD_REGRID_SHAPE = SQUARE

# GEN_ENS_PROD_CENSOR_THRESH =
# GEN_ENS_PROD_CENSOR_VAL =
# GEN_ENS_PROD_CAT_THRESH =
# GEN_ENS_PROD_NC_VAR_STR =

# Threshold for ratio of valid files to expected files to allow app to run
GEN_ENS_PROD_ENS_THRESH = 0.05

# GEN_ENS_PROD_NBRHD_PROB_WIDTH = 5
# GEN_ENS_PROD_NBRHD_PROB_SHAPE = CIRCLE
# GEN_ENS_PROD_NBRHD_PROB_VLD_THRESH = 0.0

# GEN_ENS_PROD_NMEP_SMOOTH_VLD_THRESH = 0.0
# GEN_ENS_PROD_NMEP_SMOOTH_SHAPE = CIRCLE
# GEN_ENS_PROD_NMEP_SMOOTH_GAUSSIAN_DX = 81.27
# GEN_ENS_PROD_NMEP_SMOOTH_GAUSSIAN_RADIUS = 120
# GEN_ENS_PROD_NMEP_SMOOTH_METHOD = GAUSSIAN
# GEN_ENS_PROD_NMEP_SMOOTH_WIDTH = 1

# GEN_ENS_PROD_CLIMO_MEAN_FILE_NAME =
# GEN_ENS_PROD_CLIMO_MEAN_FIELD =
# GEN_ENS_PROD_CLIMO_MEAN_REGRID_METHOD =
# GEN_ENS_PROD_CLIMO_MEAN_REGRID_WIDTH =
# GEN_ENS_PROD_CLIMO_MEAN_REGRID_VLD_THRESH =
# GEN_ENS_PROD_CLIMO_MEAN_REGRID_SHAPE =
# GEN_ENS_PROD_CLIMO_MEAN_TIME_INTERP_METHOD =
# GEN_ENS_PROD_CLIMO_MEAN_MATCH_MONTH =
# GEN_ENS_PROD_CLIMO_MEAN_DAY_INTERVAL = 31
# GEN_ENS_PROD_CLIMO_MEAN_HOUR_INTERVAL = 6

# GEN_ENS_PROD_CLIMO_STDEV_FILE_NAME =
# GEN_ENS_PROD_CLIMO_STDEV_FIELD =
# GEN_ENS_PROD_CLIMO_STDEV_REGRID_METHOD =
# GEN_ENS_PROD_CLIMO_STDEV_REGRID_WIDTH =
# GEN_ENS_PROD_CLIMO_STDEV_REGRID_VLD_THRESH =
## GEN_ENS_PROD_CLIMO_STDEV_REGRID_SHAPE =
# GEN_ENS_PROD_CLIMO_STDEV_TIME_INTERP_METHOD =
# GEN_ENS_PROD_CLIMO_STDEV_MATCH_MONTH =
# GEN_ENS_PROD_CLIMO_STDEV_DAY_INTERVAL = 31
# GEN_ENS_PROD_CLIMO_STDEV_HOUR_INTERVAL = 6

GEN_ENS_PROD_ENSEMBLE_FLAG_LATLON = TRUE
GEN_ENS_PROD_ENSEMBLE_FLAG_MEAN = TRUE
GEN_ENS_PROD_ENSEMBLE_FLAG_STDEV = TRUE
GEN_ENS_PROD_ENSEMBLE_FLAG_MINUS = FALSE
GEN_ENS_PROD_ENSEMBLE_FLAG_PLUS = FALSE
GEN_ENS_PROD_ENSEMBLE_FLAG_MIN = FALSE
GEN_ENS_PROD_ENSEMBLE_FLAG_MAX = FALSE
GEN_ENS_PROD_ENSEMBLE_FLAG_RANGE = TRUE
GEN_ENS_PROD_ENSEMBLE_FLAG_VLD_COUNT = TRUE
GEN_ENS_PROD_ENSEMBLE_FLAG_FREQUENCY = TRUE
GEN_ENS_PROD_ENSEMBLE_FLAG_NEP = TRUE
GEN_ENS_PROD_ENSEMBLE_FLAG_NMEP = TRUE
GEN_ENS_PROD_ENSEMBLE_FLAG_CLIMO = FALSE
GEN_ENS_PROD_ENSEMBLE_FLAG_CLIMO_CDF = FALSE

# GEN_ENS_PROD_ENS_MEMBER_IDS =
# GEN_ENS_PROD_CONTROL_ID =
